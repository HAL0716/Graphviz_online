<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PFTグラフ生成</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>PFT グラフ生成アプリ</h1>
    <div class="container">
        <div class="left">
            <form id="pft-form">
                <div class="form-container">
                    <div class="input-wrapper">
                        <label>シンボル</label>
                        <select name="symbols" id="symbols" multiple class="select2" style="width: 100%">
                            {% for s in symbols %}
                                <option value="{{ s }}" {% if s in ['0', '1'] %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-wrapper">
                        <label>周期</label>
                        <div class="slider-container">
                            <span id="period-value">2</span>
                            <input type="range" name="period" id="period" min="2" max="10" value="2">
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label>禁止語長</label>
                        <div class="slider-container">
                            <span id="forbidden_length-value">2</span>
                            <input type="range" name="forbidden_length" id="forbidden_length" min="2" max="10" value="2">
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label>禁止語</label>
                        <select name="forbidden_words" id="forbidden_words" multiple class="select2" style="width: 100%"></select>
                    </div>

                    <div class="input-wrapper">
                        <label><input type="checkbox" id="essentialize" name="essentialize"> 本質化</label>
                        <label><input type="checkbox" id="minimize" name="minimize" disabled> 最小化</label>
                    </div>
                </div>

                <details style="margin-top: 20px;">
                    <summary>詳細設定</summary>
                    <div class="form-container" style="margin-top: 10px;">
                        <div class="input-wrapper">
                            <label for="width">ノードの幅</label>
                            <input type="number" id="width" name="width" min="0.3" max="3.0" step="0.1" value="0.6">
                        </div>
                        <div class="input-wrapper">
                            <label for="height">ノードの高さ</label>
                            <input type="number" id="height" name="height" min="0.2" max="3.0" step="0.1" value="0.4">
                        </div>
                        <div class="input-wrapper">
                            <label for="xspacing">ノード間隔X</label>
                            <input type="number" id="xspacing" name="xspacing" min="0.5" max="3.0" step="0.1" value="1.0">
                        </div>
                        <div class="input-wrapper">
                            <label for="yspacing">ノード間隔Y</label>
                            <input type="number" id="yspacing" name="yspacing" min="0.5" max="3.0" step="0.1" value="1.0">
                        </div>
                    </div>
                </details>
            </form>
        </div>

        <div class="right">
            <div class="graph-wrapper">
                <img id="graph-image" src="" alt="生成されたグラフ">

                <div id="download-options" style="margin-top: 1em; display: flex; gap: 1em; align-items: center;">
                    <label><input type="checkbox" value="dot" checked>dot</label>
                    <label><input type="checkbox" value="tex" checked>tex</label>
                    <label><input type="checkbox" value="pdf" checked>pdf</label>
                    <label><input type="checkbox" value="png" checked>png</label>
                    <button id="download-zip" style="display: none;">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.select2').select2();

            function updateForbiddenWords(callback = null) {
                const symbols = $('#symbols').val();
                const length = $('#forbidden_length').val();

                $.ajax({
                    type: 'POST',
                    url: '/get_forbidden_words',
                    contentType: 'application/json',
                    data: JSON.stringify({ symbols, length }),
                    success: function (data) {
                        const $fw = $('#forbidden_words');
                        $fw.empty();
                        data.forEach((word, idx) => {
                            $fw.append(new Option(word, word, idx === 0, idx === 0));
                        });
                        $fw.trigger('change');
                        if (callback) callback();
                    }
                });
            }

            function updateGraph() {
                const payload = {
                    symbols: $('#symbols').val(),
                    period: $('#period').val(),
                    forbidden_length: $('#forbidden_length').val(),
                    forbidden_words: $('#forbidden_words').val(),
                    essentialize: $('#essentialize').is(':checked'),
                    minimize: $('#minimize').is(':checked'),
                    width: $('#width').val(),
                    height: $('#height').val(),
                    xspacing: $('#xspacing').val(),
                    yspacing: $('#yspacing').val()
                };

                $.ajax({
                    type: 'POST',
                    url: '/generate',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        $('#graph-image').attr('src', response.image_url).show();
                        $('#download-zip').show();
                    }
                });
            }

            function saveSettings() {
                const settings = {
                    symbols: $('#symbols').val(),
                    period: $('#period').val(),
                    forbidden_length: $('#forbidden_length').val(),
                    forbidden_words: $('#forbidden_words').val(),
                    width: $('#width').val(),
                    height: $('#height').val(),
                    xspacing: $('#xspacing').val(),
                    yspacing: $('#yspacing').val()
                };
                localStorage.setItem('pftSettings', JSON.stringify(settings));
            }

            function loadSettings() {
                const saved = localStorage.getItem('pftSettings');
                if (!saved) return;
                const s = JSON.parse(saved);
                $('#period').val(s.period).trigger('input');
                $('#forbidden_length').val(s.forbidden_length).trigger('input');
                $('#width').val(s.width);
                $('#height').val(s.height);
                $('#xspacing').val(s.xspacing);
                $('#yspacing').val(s.yspacing);
                $('#symbols').val(s.symbols).trigger('change');
                setTimeout(() => {
                    $('#forbidden_words').val(s.forbidden_words).trigger('change');
                }, 300);
            }

            $('#symbols, #period, #forbidden_length, #forbidden_words, #width, #height, #xspacing, #yspacing')
                .on('change input', saveSettings);

            $('#period').on('input', function () {
                $('#period-value').text($(this).val());
                updateGraph();
            });

            $('#forbidden_length').on('input', function () {
                $('#forbidden_length-value').text($(this).val());
                updateGraph();
            });

            $('#symbols, #forbidden_length').on('change', function () {
                updateForbiddenWords(updateGraph);
            });

            $('#essentialize').on('change', function () {
                const essentialOn = $(this).is(':checked');
                $('#minimize').prop('disabled', !essentialOn);
                if (!essentialOn) $('#minimize').prop('checked', false);
                updateGraph();
            });

            $('#period, #forbidden_words, #width, #height, #xspacing, #yspacing, #minimize').on('change input', updateGraph);

            $('#download-zip').on('click', function () {
                const selected = $('#download-options input[type=checkbox]:checked')
                    .map(function () { return this.value; })
                    .get();

                if (selected.length === 0) return alert('少なくとも1つ拡張子を選んでください');
                const query = selected.map(ext => `ext=${ext}`).join('&');
                window.location.href = `/download?${query}`;
            });

            loadSettings();
            updateForbiddenWords(updateGraph);
        });
    </script>    
</body>
</html>
